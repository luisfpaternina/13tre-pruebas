<?xml version="1.0" encoding="utf-8"?>
<odoo>

     <record model="ir.ui.view" id="payroll_news_form_view">
        <field name="name">hr.payroll.news.form</field>
        <field name="model">hr.payroll.news</field>
        <field eval="2" name="priority"/>
        <field name="arch" type="xml">
            <form string="Payroll News Form" class="o_form_project_tasks">
                <field name="is_liquidated" invisible="1"/>
                <field name="date_range_apply" invisible="1"/>
                <header>
                    <field name="stage_id" widget="statusbar" options="{'clickable': '1', 'fold_field': 'fold'}"/>
                    <button name="action_post" string="Liquidate" class="oe_highlight"
                        type="object" groups="base.group_user"
                        invisible="1"/>
                    <button name="action_add_employees" type="object" string="Add Employees" class="oe_highlight"/>
                </header>
                <sheet>
                    <widget name="web_ribbon" title="Archived" bg_color="bg-danger" attrs="{'invisible': [('active', '=', True)]}"/>
                    <div class="oe_title pr-0">
                        <h1 class="d-flex flex-row justify-content-between">
                            <field name="priority" widget="priority" class="mr-3"/>
                            <field name="name" class="o_task_name text-truncate" placeholder="Title..."/>
                            <field name="kanban_state" widget="state_selection" class="ml-auto"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="payroll_structure_id" options="{'no_create': True}"/>
                            <field name="salary_rule_id" options="{'no_create': True}"/>
                            <field name="replicate_new" />
                            <field name="user_id"
                                class="o_task_user_field"
                                options='{"no_open": True}'/>
                           <!--  <field name="partner_id"/> -->
                            <field name="email_from" invisible="1"/>
                            <field name="active" invisible="1"/>

                            <label for="request_date_from" string="From" attrs="{'invisible': [('date_range_apply', '=', False)], 'required': [('date_range_apply', '=', True)]}"/>
                            <div class="o_row o_row_readonly o_hr_holidays_dates">
                                <field name="request_date_from" class="oe_inline" attrs="{'invisible': [('date_range_apply', '=', False)], 'required': [('date_range_apply', '=', True)]}" autocomplete="off"/>
                                <span class="oe_inline" attrs="{'invisible': [('date_range_apply', '=', False)]}">
                                    To
                                </span>
                                <field name="request_date_to" class="oe_inline"
                                attrs="{'invisible': [('date_range_apply', '=', False)], 'required': [('date_range_apply', '=', True)]}" autocomplete="off"/>
                            </div>
                        </group>
                        <group>
                            <field name="date_start"/>
                            <field name="date_end"/>
                            <field name="date_deadline" invisible="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page name="employees_page" string="Employees">
                            <group>
                                <field name="employee_payroll_news_ids" nolabel="1">
                                    <tree editable="bottom">
                                        <field name="payroll_news_id" invisible="1"/>
                                        <field name="employee_id"/>
                                        <field name="quantity" sum="Total qty"/>
                                        <field name="amount" sum="Total amount"/>
                                        <field name="total" sum="Total qty amount"/>
                                    </tree>
                                </field>
                            </group>
                        </page>
                        <page name="description_page" string="Description">
                            <field name="description" placeholder="Add a description..."/>
                            <div class="oe_clear"/>
                        </page>
                    </notebook>
                </sheet>

                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers" groups="base.group_user"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <record id="view_payroll_news_kanban" model="ir.ui.view">
        <field name="name">hr.payroll.news.kanban</field>
        <field name="model">hr.payroll.news</field>
        <field name="arch" type="xml">
            <kanban quick_create="false" default_group_by="stage_id" class="o_kanban_small_column o_opportunity_kanban o_kanban_mobile" archivable="false" group_create="false">
                <field name="color"/>
                <field name="stage_id" options='{"group_by_tooltip": {"requirements": "Description"}}'/>
                <field name="name"/>
                <!-- <field name="partner_id"/> -->
                <field name="user_id"/>
                <field name="date_deadline"/>
                <field name="date_deadline_formatted"/>
                <field name="activity_ids"/>
                <field name="activity_state"/>
                <field name="message_needaction_counter"/>
                <field name="label_employees"/>
                <field name="employee_count"/>
                <field name="payroll_structure_id"/>
                <field name="salary_rule_name"/>
                <progressbar field="kanban_state" colors='{"done": "success", "blocked": "danger", "normal": "muted"}'/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="{{!selection_mode ? 'oe_kanban_color_' + kanban_getcolor(record.color.raw_value) : ''}} oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                    <br />
                                    <span>
                                        <strong>
                                            <field name="payroll_structure_id"/>
                                        </strong>
                                    </span>
                                    <br />
                                    <span>
                                        <field name="salary_rule_name"/>
                                    </span>
                                    <br />
                                    <span>
                                        <field name="user_id"/>
                                    </span>
                                    <br />
                                    <a class="o_project_kanban_box" t-if="widget.editable" role="menuitem" type="edit">
                                        <div>
                                            <span class="o_value"><t t-esc="record.employee_count.value"/></span>
                                            <span class="o_label"><t t-esc="record.label_employees.value"/></span>
                                        </div>
                                    </a>
                                </div>
                                <div class="o_dropdown_kanban dropdown" t-if="!selection_mode" groups="base.group_user">
                                    <a role="button" class="dropdown-toggle o-no-caret btn" data-toggle="dropdown" data-display="static" href="#" aria-label="Dropdown menu" title="Dropdown menu">
                                        <span class="fa fa-ellipsis-v"/>
                                    </a>
                                    <div class="dropdown-menu" role="menu">
                                        <a t-if="widget.editable" role="menuitem" type="set_cover" class="dropdown-item" data-field="displayed_image_id">Set Cover Image</a>
                                        <a name="%(portal.portal_share_action)d" role="menuitem" type="action" class="dropdown-item">Share</a>
                                        <a t-if="widget.editable" role="menuitem" type="edit" class="dropdown-item">Edit payroll news</a>
                                        <a t-if="widget.deletable" role="menuitem" type="delete" class="dropdown-item">Delete</a>
                                        <div role="separator" class="dropdown-divider"></div>
                                        <ul class="oe_kanban_colorpicker" data-field="color"/>
                                    </div>
                                </div>
                            </div>
                            <div>
                                
                            </div>
                            <div class="o_kanban_record_bottom" t-if="!selection_mode">
                                    <div class="oe_kanban_bottom_left">
                                        <field name="priority" widget="priority"/>
                                        <field name="activity_ids" widget="kanban_activity"/>
                                        <t t-if="record.message_needaction_counter.raw_value">
                                            <span role="alert" class='oe_kanban_mail_new' title='Unread Messages'><i class='fa fa-comments' role="img" aria-label="Unread Messages"/><t t-raw="record.message_needaction_counter.raw_value"/></span>
                                        </t>
                                        <!-- formating of the date -->
                                        <t t-set="date_format" t-value="'MM/DD/YY'" />
                                        <t t-set="date" t-value=""/>
                                        <!-- color of the span -->
                                        <t t-if="record.date_deadline.raw_value and moment(record.date_deadline.raw_value.toISOString()).startOf('day') lt moment().startOf('day')">
                                            <t t-set="deadline_class" t-value="'oe_kanban_text_red'" />
                                        </t>
                                        <t t-elif="record.date_deadline.raw_value and moment(record.date_deadline.raw_value.toISOString()).startOf('day') lt moment().endOf('day')">
                                            <t t-set="deadline_class" t-value="'text-warning font-weight-bold'" />
                                        </t>
                                        <!-- Date value -->
                                        <t t-if="record.date_deadline.raw_value" t-set="date" t-value="record.date_deadline_formatted.raw_value" />
                                        <span name="date" t-attf-class="#{deadline_class || ''}"><t t-esc="date" /></span>
                                    </div>
                                    <div class="oe_kanban_bottom_right" t-if="!selection_mode">
                                        <field name="kanban_state" widget="state_selection" groups="base.group_user" invisible="context.get('fsm_mode', False)"/>
                                    </div>
                                </div>
                            
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="view_payroll_news_tree" model="ir.ui.view">
        <field name="name">hr.payroll.news.tree</field>
        <field name="model">hr.payroll.news</field>
        <field name="arch" type="xml">
            <tree decoration-bf="message_needaction==True" decoration-danger="date_deadline and (date_deadline&lt;current_date)">
                <field name="message_needaction" invisible="1"/>
                <field name="name"/>
                <field name="payroll_structure_id"/>
                <field name="salary_rule_id"/>
                <field name="date_start"/>
                <field name="date_end"/>
                <field name="date_deadline" optional="hide"/>
                <field name="user_id" optional="hide"/>
                <field name="stage_id"/>
                <field name="activity_exception_decoration" widget="activity_exception"/>
            </tree>
        </field>
    </record>

    <record id="payroll_news_view_tree_activity" model="ir.ui.view">
        <field name="name">hr.payroll.news.tree.activity</field>
        <field name="model">hr.payroll.news</field>
        <field name="arch" type="xml">
            <tree decoration-danger="activity_date_deadline &lt; current_date" default_order="activity_date_deadline">
                <field name="name"/>
                <field name="activity_date_deadline"/>
                <field name="activity_type_id"/>
                <field name="activity_summary"/>
                <field name="stage_id"/>
            </tree>
        </field>
    </record>

    <record id="view_payroll_news_calendar" model="ir.ui.view">
        <field name="name">hr.payroll.news.calendar</field>
        <field name="model">hr.payroll.news</field>
        <field eval="2" name="priority"/>
        <field name="arch" type="xml">
            <calendar date_start="date_deadline" string="Payroll news" mode="month" color="user_id" event_limit="5" hide_time="true">
                <field name="user_id" avatar_field="image_128"/>
                <field name="date_deadline"/>
                <field name="priority" widget="priority"/>
                <field name="stage_id"/>
            </calendar>
        </field>
    </record>

    <record id="view_payroll_news_pivot" model="ir.ui.view">
        <field name="name">hr.payroll.news.pivot</field>
        <field name="model">hr.payroll.news</field>
        <field name="arch" type="xml">
            <pivot string="Payroll News">
                <!-- <field name="partner_id" type="row"/> -->
                <field name="stage_id" type="col"/>
            </pivot>
        </field>
    </record>

    <record id="view_payroll_news_graph" model="ir.ui.view">
        <field name="name">hr.payroll.news.graph</field>
        <field name="model">hr.payroll.news</field>
        <field name="arch" type="xml">
            <graph string="Payroll News">
                <!-- <field name="partner_id"/> -->
                <field name="stage_id"/>
            </graph>
        </field>
    </record>

    <record id="payroll_news_view_activity" model="ir.ui.view">
        <field name="name">hr.payroll.news.activity</field>
        <field name="model">hr.payroll.news</field>
        <field name="arch" type="xml">
            <activity string="Payroll News">
                <field name="user_id"/>
                <templates>
                    <div t-name="activity-box">
                        <img t-att-src="activity_image('res.users', 'image_128', record.user_id.raw_value)" t-att-title="record.user_id.value" t-att-alt="record.user_id.value"/>
                        <div>
                            <field name="name" display="full"/>
                        </div>
                    </div>
                </templates>
            </activity>
        </field>
    </record>

    <record id="hr_payroll_news_view_search_register" model="ir.ui.view">
        <field name="name">hr.payroll.news.search.view</field>
        <field name="model">hr.payroll.news</field>
        <field name="arch" type="xml">
            <search string="Search Payroll News">
                <filter string="Current Month" name="current_month" domain="['|', '&amp;',
                    ('date_end', '&lt;', ( context_today() + relativedelta(months=1)).strftime('%%Y-%%m-01')),
                    ('date_start','&gt;=',time.strftime('%%Y-%%m-01')) , '&amp;', 
                    ('date_end', '&gt;=', ( context_today() + relativedelta(months=1)).strftime('%%Y-%%m-01')),
                    ('date_start','&lt;=',time.strftime('%%Y-%%m-01'))]"/>
            </search>
        </field>
    </record>

    <record model="ir.actions.act_window" id="payroll_news_list_action">
        <field name="name">Playroll news</field>
        <field name="res_model">hr.payroll.news</field>
        <field name="view_mode">kanban,tree,form,calendar,pivot,graph,activity</field>
        <field name="search_view_id" ref="hr_payroll_news_view_search_register"/>
        <field name="context">{'search_default_current_month': 1}</field>
    </record>

    <record id="payroll_news_kanban_action" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="view_payroll_news_kanban"/>
        <field name="act_window_id" ref="payroll_news_list_action"/>
    </record>

    <record id="payroll_news_tree_action" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="view_payroll_news_tree"/>
        <field name="act_window_id" ref="payroll_news_list_action"/>
    </record>

    <!-- Empleados por novedades -->

    <record id="view_employee_payroll_news_search_form" model="ir.ui.view">
        <field name="name">hr.employee.payroll.news.search.form</field>
        <field name="model">hr.employee.payroll.news</field>
        <field name="arch" type="xml">
           <search string="Employee Payroll News">
                <field name="employee_id"/>
                <field name="quantity"/>
                <field name="amount"/>
                <field name="total"/>
                <group expand="0" string="Group By">
                    <filter string="Playroll News" name="hr_payroll_news" context="{'group_by': 'payroll_news_id'}"/>
                    <filter string="Employee" name="employee" context="{'group_by': 'employee_id'}"/>
                </group>
            </search>
        </field>
    </record>
    
    <record id="view_employee_payroll_news_tree" model="ir.ui.view">
        <field name="name">hr.employee.payroll.news.tree</field>
        <field name="model">hr.employee.payroll.news</field>
        <field name="arch" type="xml">
            <tree create="false" edit="false">
                <field name="employee_id"/>
                <field name="payroll_news_id"/>
                <field name="stage_name"/>
                <field name="structure_name"/>
                <field name="rule_name"/>
                <field name="quantity"/>
                <field name="amount"/>
                <field name="total"/>
            </tree>
        </field>
    </record>

    <record model="ir.actions.act_window" id="employee_payroll_news_list_action">
        <field name="name">Employee Payroll News</field>
        <field name="res_model">hr.employee.payroll.news</field>
        <field name="view_mode">tree</field>
        <field name="search_view_id" ref="view_employee_payroll_news_search_form"/>
    </record>
    
    <menuitem
        id="payroll_news_menu_root"
        name="Payroll News"
        web_icon="bits_hr_payroll_news,static/description/icon.png"
        sequence="1"/>

    <menuitem
        id="main_payroll_news_menu" 
        name="Payroll News" 
        parent="payroll_news_menu_root" 
        sequence="10"/>

    <menuitem 
        id="payroll_news_menu"
        name="Payroll News"
        parent="main_payroll_news_menu"
        action="payroll_news_list_action"
        sequence="10"/>

    <menuitem 
        id="payroll_news_employee_menu"
        name="Employees"
        parent="main_payroll_news_menu"
        action="employee_payroll_news_list_action"
        sequence="20"/>

    <menuitem
        id="playroll_news_menu_config"
        name="Configuration"
        parent="payroll_news_menu_root"
        sequence="25"/>

    <menuitem
        id="menu_playroll_news_config"
        name="Payroll news"
        parent="playroll_news_menu_config"
        sequence="15"/>

</odoo>
